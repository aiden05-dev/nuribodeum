<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>ëˆ„ë¦¬ë³´ë“¬ Â· ë³‘ë™ ì»¤ë®¤ë‹ˆí‹° (í†µí•© í…ŒìŠ¤íŠ¸)</title>
<style>
/* ===== ê³µí†µ UI ===== */
html{font-size:clamp(18px,2.2vw,26px);}
body{margin:0;background:#f7f8fa;color:#1b1e23;font-family:system-ui,'Noto Sans KR',sans-serif;line-height:1.6;}
header{position:sticky;top:0;background:#fff;border-bottom:1px solid #e5e7eb;z-index:5;}
.toolbar{display:flex;justify-content:space-between;align-items:center;padding:12px 16px;}
.title{font-size:1.4rem;font-weight:800;}
.controls{display:flex;gap:8px;flex-wrap:wrap;}
button{font-size:1rem;border:none;border-radius:12px;cursor:pointer;padding:10px 18px;min-height:46px;}
.primary{background:#3b82f6;color:#fff;}
.ghost{background:#fff;border:2px solid #e5e7eb;}
.badge{display:inline-block;padding:2px 8px;border-radius:999px;border:1px solid #e5e7eb;font-size:.85rem;color:#64748b;}
.kicker{color:#64748b;font-size:.95rem;}
hr.sep{border:none;border-top:1px dashed #e5e7eb;margin:10px 0;}
main{max-width:min(96vw,1550px);margin:0 auto;padding:clamp(12px,3vw,24px);display:flex;flex-direction:column;gap:20px;}
.section-block{display:flex;align-items:center;gap:18px;background:#fff;border:2px solid #e5e7eb;border-radius:20px;padding:28px;box-shadow:0 5px 10px rgba(0,0,0,.05);cursor:pointer;transition:.2s;min-height:140px;}
.section-block:hover{border-color:#3b82f6;transform:translateY(-2px);}
.section-icon{font-size:2.4rem;}
.section-title{font-size:1.3rem;font-weight:700;}
.page{display:none;} .page.active{display:block;}
.grid2{display:grid;gap:16px;grid-template-columns:1fr;}
@media(min-width:980px){.grid2{grid-template-columns:1fr 1fr;}}
.card{background:#fff;border:2px solid #e5e7eb;border-radius:18px;padding:20px;box-shadow:0 4px 10px rgba(0,0,0,.05);}
.list{display:grid;gap:10px;}
.item{background:#fff;border:1px solid #e5e7eb;border-radius:16px;padding:14px;display:grid;gap:8px;}
.item .meta{color:#64748b;font-size:.95rem;}
.row{display:flex;gap:10px;align-items:center;flex-wrap:wrap;}
.tag{border:1px dashed #cbd5e1;padding:8px 12px;border-radius:999px;cursor:pointer;}
.tag[aria-pressed="true"]{border-style:solid;background:#eef2ff;}
.date-btn[aria-pressed="true"]{background:#3b82f6;color:#fff;border-color:transparent}

/* ===== ì±„íŒ… ëª¨ë‹¬ ===== */
.dialog{position:fixed;inset:0;background:rgba(0,0,0,.5);display:none;justify-content:center;align-items:center;}
.dialog.active{display:flex;}
.chatbox{background:#fff;border-radius:18px;padding:16px;max-width:860px;width:92%;max-height:86vh;display:flex;flex-direction:column;gap:10px;border:2px solid #e5e7eb;}
.chatlog{overflow:auto;flex:1;display:flex;flex-direction:column;gap:8px;background:#fff;border:1px solid #e5e7eb;border-radius:12px;padding:10px;}
.bubble{padding:10px 14px;border-radius:14px;max-width:75%;word-break:break-word;}
.me{align-self:flex-end;background:#e0ecff;}
.other{align-self:flex-start;background:#f1f5f9;}
select,
textarea,
input[type="number"],
input[type="text"] {
  font-size: 1.1rem;          /* ê¸€ì í¬ê¸° í™•ëŒ€ */
  line-height: 1.5;
  padding: 14px 16px;         /* ë‚´ë¶€ ì—¬ë°± í™•ëŒ€ */
  border: 2px solid #d1d5db;  /* í…Œë‘ë¦¬ ì‚´ì§ ì§„í•˜ê²Œ */
  border-radius: 12px;
  transition: border-color 0.2s, box-shadow 0.2s;
}

/* í¬ì»¤ìŠ¤ ì‹œ ì¢€ ë” ëšœë ·í•˜ê²Œ */
select:focus,
textarea:focus,
input:focus {
  outline: none;
  border-color: #3b82f6;
  box-shadow: 0 0 0 3px rgba(59,130,246,0.15);
}

/* ===== ë‚ ì§œ ë²„íŠ¼ í¬ê¸°ë„ ê· í˜• ë§ì¶”ê¸° ===== */
.date-btn {
  font-size: 1.05rem;
  padding: 10px 16px;
  border-radius: 10px;
}
.logo img {
  height: 96px;
  width: auto;
  margin-right: 16px; /* ì œëª©ê³¼ ê°„ê²© */
}


/* ì œëª©ê³¼ ë¡œê³  ì •ë ¬ ë³´ì • */
.toolbar {
  display: flex;
  align-items: center;
  justify-content: space-between;
  gap: 10px;
}

.title {
  flex: 1;
  text-align: left;      /* ë¡œê³  ì˜†ìœ¼ë¡œ ì œëª© ì •ë ¬ */
}
</style>
</head>
<body>
<header>
  <div class="toolbar">
    <div class="logo">
      <img src="logo.png" alt="ë³´ë“¬ON ë¡œê³ " />
    </div>
    <div class="title">ëˆ„ë¦¬ë³´ë“¬ Â· ë³‘ë™ ì»¤ë®¤ë‹ˆí‹°</div>
    <div class="controls">
      <button id="edit-profile" class="ghost">ë‹‰ë„¤ì„ ìˆ˜ì •</button>
    </div>
  </div>
</header>

<main>
  <!-- ===== í™ˆ ===== -->
  <section id="home" class="page active" aria-label="í™ˆ">
    <div class="section-block" data-go="page-meal"><div class="section-icon">ğŸš</div><div class="section-title">ì‹ì‚¬ ëª¨ì„ ë§Œë“¤ê¸° Â· ì°¸ì—¬í•˜ê¸°</div></div>
    <div class="section-block" data-go="page-activity"><div class="section-icon">ğŸ¯</div><div class="section-title">ê´€ì‹¬ì‚¬ ëª¨ì„ ë§Œë“¤ê¸° Â· ì°¸ì—¬í•˜ê¸°</div></div>
    <div class="section-block" data-go="page-match"><div class="section-icon">ğŸ’¬</div><div class="section-title">1:1 ëŒ€í™”(ë¡œì»¬ ë°ëª¨)</div></div>
    <div class="section-block" data-go="page-my-chats"><div class="section-icon">ğŸ“‚</div><div class="section-title">ë‚´ ì±„íŒ…ë°© ê´€ë¦¬</div></div>
  </section>

  <!-- ===== ì‹ì‚¬ ëª¨ì„ ===== -->
  <section id="page-meal" class="page" aria-labelledby="meal-title">
    <button class="ghost" data-back>â† ë’¤ë¡œ</button>
    <h2 id="meal-title">ì‹ì‚¬ ëª¨ì„</h2>
    <div class="grid2" style="margin-top:8px;">
      <!-- ë§Œë“¤ê¸° -->
      <div class="card">
        <h3 style="margin-bottom:12px;">ğŸ± ì‹ì‚¬ ëª¨ì„ ë§Œë“¤ê¸°</h3>
        <div class="row" style="margin-bottom:12px;">
          <div style="flex:1;">
            <label class="kicker" style="display:block;margin-bottom:6px;">ë‚ ì§œ</label>
            <div id="meal-date-group" class="row" style="gap:6px;">
              <button class="ghost date-btn" data-group="meal" data-date="0" aria-pressed="true">ì˜¤ëŠ˜</button>
              <button class="ghost date-btn" data-group="meal" data-date="1">ë‚´ì¼</button>
              <button class="ghost date-btn" data-group="meal" data-date="2">ëª¨ë ˆ</button>
            </div>
          </div>
          <div style="flex:1;">
            <label class="kicker" style="display:block;margin-bottom:6px;">ì‹œê°„ëŒ€</label>
            <select id="meal-slot" style="width:100%;padding:10px 12px;border:1px solid #e5e7eb;border-radius:10px;">
              <option>ì ì‹¬(11:30~13:00)</option>
              <option>í‹°íƒ€ì„(15:00~16:00)</option>
              <option>ì €ë…(17:30~19:00)</option>
            </select>
          </div>
        </div>

        <div style="margin-bottom:12px;">
          <label class="kicker" style="display:block;margin-bottom:6px;">ì¥ì†Œ</label>
          <select id="meal-place" style="width:100%;padding:10px 12px;border:1px solid #e5e7eb;border-radius:10px;">
            <option>íœ´ê²Œë¼ìš´ì§€ A</option>
            <option>íœ´ê²Œë¼ìš´ì§€ B</option>
            <option>ë³µë„ ë²¤ì¹˜ êµ¬ì—­</option>
            <option>ì˜¥ìƒ ì •ì›</option>
          </select>
        </div>

        <div class="row" style="align-items:center;justify-content:space-between;margin-bottom:10px;">
          <div>
            <label class="kicker" style="display:block;margin-bottom:4px;">ì¸ì›(ë³¸ì¸ í¬í•¨)</label>
            <input id="meal-cap" type="number" min="2" max="10" value="2"
              style="width:100px;padding:8px 10px;border:1px solid #e5e7eb;border-radius:10px;text-align:center;" />
          </div>
          <span class="kicker" style="font-size:0.9rem;">â€» ê°œì¸ì •ë³´ ì…ë ¥ ê¸ˆì§€</span>
        </div>

        <div style="text-align:right;margin-top:8px;">
          <button id="meal-save" class="primary" style="padding:12px 20px;border-radius:12px;font-weight:600;">
            ë“±ë¡í•˜ê¸°
          </button>
        </div>
      </div>

      <!-- ëª©ë¡ -->
      <div class="card">
        <div class="row" style="justify-content:space-between;align-items:center;">
          <h3>ëª¨ì„ ëª©ë¡</h3>
          <div class="row">
            <button id="meal-refresh" class="ghost">ìƒˆë¡œê³ ì¹¨</button>
            <span class="badge" id="meal-count">0ê±´</span>
          </div>
        </div>
        <div id="meal-list" class="list"></div>
      </div>
    </div>
  </section>

  <!-- ===== ê´€ì‹¬ì‚¬ ëª¨ì„ ===== -->
  <section id="page-activity" class="page" aria-labelledby="act-title">
    <button class="ghost" data-back>â† ë’¤ë¡œ</button>
    <h2 id="act-title">ê´€ì‹¬ì‚¬ ëª¨ì„</h2>
    <div class="grid2" style="margin-top:8px;">
      <div class="card">
        <h3 style="margin-bottom:12px;">ğŸ¯ ê´€ì‹¬ì‚¬ ëª¨ì„ ë§Œë“¤ê¸°</h3>

        <div class="row" style="margin-bottom:12px;">
          <div style="flex:1;">
            <label class="kicker" style="display:block;margin-bottom:6px;">ë‚ ì§œ</label>
            <div id="act-date-group" class="row" style="gap:6px;">
              <button class="ghost date-btn" data-group="act" data-date="0" aria-pressed="true">ì˜¤ëŠ˜</button>
              <button class="ghost date-btn" data-group="act" data-date="1">ë‚´ì¼</button>
              <button class="ghost date-btn" data-group="act" data-date="2">ëª¨ë ˆ</button>
            </div>
          </div>
          <div style="flex:1;">
            <label class="kicker" style="display:block;margin-bottom:6px;">ì‹œê°„ëŒ€</label>
            <select id="act-slot" style="width:100%;padding:10px 12px;border:1px solid #e5e7eb;border-radius:10px;">
              <option>ì˜¤ì „(09:00~11:00)</option>
              <option>ì˜¤í›„(13:30~15:30)</option>
              <option>ì €ë…(18:00~20:00)</option>
            </select>
          </div>
        </div>

        <label class="kicker" style="display:block;margin-bottom:6px;">ì¥ì†Œ</label>
        <select id="act-place" style="width:100%;padding:10px 12px;border:1px solid #e5e7eb;border-radius:10px;">
          <option>íœ´ê²Œë¼ìš´ì§€ A</option>
          <option>íœ´ê²Œë¼ìš´ì§€ B</option>
          <option>ë³µë„ ë²¤ì¹˜ êµ¬ì—­</option>
          <option>ì˜¥ìƒ ì •ì›</option>
        </select>

        <div style="margin:12px 0;">
          <label class="kicker" style="display:block;margin-bottom:6px;">ê´€ì‹¬ì‚¬</label>
          <div id="act-tags" class="row" style="gap:8px;">
            <button class="tag" aria-pressed="false">ìŒì•… ê°ìƒ</button>
            <button class="tag" aria-pressed="false">ë“œë¼ë§ˆ/ì˜í™”</button>
            <button class="tag" aria-pressed="false">ë…ì„œ</button>
            <button class="tag" aria-pressed="false">ì‚°ì±…</button>
            <button class="tag" aria-pressed="false">ê·¸ë¦¼/ìƒ‰ì¹ </button>
            <button class="tag" aria-pressed="false">í¼ì¦</button>
            <button class="tag" aria-pressed="false">ì¢…êµëŒ€í™”</button>
            <button class="tag" aria-pressed="false">ì¡ë‹´/ìˆ˜ë‹¤</button>
          </div>
        </div>

        <label class="kicker" style="display:block;margin-bottom:6px;">ë©”ëª¨</label>
        <textarea id="act-note" placeholder="ì˜ˆ) ì¡°ìš©í•œ í™œë™ ì›í•´ìš” (ê°œì¸ì •ë³´ ê¸ˆì§€)"
          style="width:100%;padding:12px 14px;border:1px solid #e5e7eb;border-radius:10px;resize:vertical;min-height:80px;"></textarea>

        <div class="row" style="align-items:center;justify-content:space-between;margin:10px 0;">
          <div>
            <label class="kicker" style="display:block;margin-bottom:4px;">ì¸ì›(ë³¸ì¸ í¬í•¨)</label>
            <input id="act-cap" type="number" min="2" max="10" value="2"
              style="width:100px;padding:8px 10px;border:1px solid #e5e7eb;border-radius:10px;text-align:center;" />
          </div>
        </div>

        <div style="text-align:right;margin-top:8px;">
          <button id="act-save" class="primary" style="padding:12px 20px;border-radius:12px;font-weight:600;">
            ë“±ë¡í•˜ê¸°
          </button>
        </div>
      </div>

      <div class="card">
        <div class="row" style="justify-content:space-between;align-items:center;">
          <h3>ëª¨ì„ ëª©ë¡</h3>
          <div class="row">
            <button id="act-refresh" class="ghost">ìƒˆë¡œê³ ì¹¨</button>
            <button id="act-filter-my" class="ghost">ë‚´ ê´€ì‹¬ì‚¬ë§Œ</button>
            <span class="badge" id="act-count">0ê±´</span>
          </div>
        </div>
        <div id="act-list" class="list"></div>
      </div>
    </div>
  </section>

  <!-- ===== 1:1 ë§¤ì¹­ ===== -->
<section id="page-match" class="page" aria-labelledby="match-title">
  <button class="ghost" data-back>â† ë’¤ë¡œ</button>
  <h2 id="match-title">1:1 ëŒ€í™”</h2>
  <div class="card">
    <p class="kicker">ë‹¤ë¥¸ ì´ìš©ìì™€ 1:1 ëŒ€í™”ë¥¼ ì‹œì‘í•©ë‹ˆë‹¤. ê°œì¸ì •ë³´ëŠ” ì…ë ¥í•˜ì§€ ë§ˆì„¸ìš”.</p>
    <div class="row" style="margin-bottom:8px;">
      <button id="match-start" class="primary">ë§¤ì¹­ ìš”ì²­</button>
      <span id="match-state" class="badge" style="margin-left:auto;">ëŒ€ê¸° ì¤‘ ì•„ë‹˜</span>
    </div>
    <div id="demo-log" class="list" style="max-height:220px;overflow:auto;"></div>
  </div>
</section>

<script type="module">
/* ===== 1:1 ë§¤ì¹­ (Supabase ì‹¤ì‹œê°„ ë²„ì „) ===== */
let matchInterval = null;
let isMatching = false;

function addDemoMsg(text) {
  const log = document.querySelector('#demo-log');
  const div = document.createElement('div');
  div.className = 'item';
  div.textContent = text;
  log.appendChild(div);
  log.scrollTop = log.scrollHeight;
}

function updateMatchState(text) {
  document.querySelector('#match-state').textContent = text;
  addDemoMsg(text);
}

async function startMatching() {
  PROFILE = await ensureProfile();
  if (isMatching) return;

  isMatching = true;
  updateMatchState('ë§¤ì¹­ ëŒ€ê¸°ì—´ ë“±ë¡ ì¤‘...');

  // 1ï¸âƒ£ ë³¸ì¸ì„ Supabase match_queueì— ë“±ë¡
  const { error: insertErr } = await sb
    .from('match_queue')
    .upsert([{ user_id: PROFILE.id, nickname: PROFILE.nickname }]);
  if (insertErr) {
    isMatching = false;
    return alert('ë§¤ì¹­ ëŒ€ê¸° ë“±ë¡ ì‹¤íŒ¨: ' + insertErr.message);
  }

  updateMatchState('ë§¤ì¹­ ëŒ€ê¸° ì¤‘... (3ì´ˆë§ˆë‹¤ íƒìƒ‰)');

  // 2ï¸âƒ£ 3ì´ˆë§ˆë‹¤ ëŒ€ê¸°ì íƒìƒ‰
  matchInterval = setInterval(async () => {
    const { data: queue } = await sb
      .from('match_queue')
      .select('*')
      .order('created_at');

    const others = (queue || []).filter(q => q.user_id !== PROFILE.id);
    if (others.length > 0) {
      const partner = others[0];
      updateMatchState(`ë§¤ì¹­ ì„±ê³µ! ìƒëŒ€: ${partner.nickname}`);

      clearInterval(matchInterval);
      isMatching = false;

      // 3ï¸âƒ£ Supabase rooms ìƒì„±
      const { data: room, error: roomErr } = await sb
        .from('rooms')
        .insert([{ created_by: PROFILE.id, created_by_nick: PROFILE.nickname, type: 'direct' }])
        .select()
        .single();

      if (roomErr) return alert('ì±„íŒ…ë°© ìƒì„± ì‹¤íŒ¨: ' + roomErr.message);

      // 4ï¸âƒ£ ë‘ ì°¸ê°€ì ë“±ë¡
      await sb.from('room_participants').insert([
        { room_id: room.id, user_id: PROFILE.id, nickname: PROFILE.nickname },
        { room_id: room.id, user_id: partner.user_id, nickname: partner.nickname },
      ]);

      // 5ï¸âƒ£ ëŒ€ê¸°ì—´ì—ì„œ ë‘ ì‚¬ëŒ ì‚­ì œ
      await sb.from('match_queue').delete().in('user_id', [PROFILE.id, partner.user_id]);

      // 6ï¸âƒ£ ì±„íŒ…ë°© ì—´ê¸°
      openChatModal(room.id, `1:1 ëŒ€í™” (${partner.nickname})`);
    }
  }, 3000);
}

async function cancelMatching() {
  PROFILE = await ensureProfile();
  await sb.from('match_queue').delete().eq('user_id', PROFILE.id);
  clearInterval(matchInterval);
  isMatching = false;
  updateMatchState('ë§¤ì¹­ì´ ì·¨ì†Œë˜ì—ˆìŠµë‹ˆë‹¤.');
}

document.querySelector('#match-start').addEventListener('click', () => {
  const btn = document.querySelector('#match-start');
  if (isMatching) {
    cancelMatching();
    btn.textContent = 'ë§¤ì¹­ ìš”ì²­';
    btn.classList.remove('ghost');
    btn.classList.add('primary');
  } else {
    startMatching();
    btn.textContent = 'ë§¤ì¹­ ì·¨ì†Œ';
    btn.classList.remove('primary');
    btn.classList.add('ghost');
  }
});
</script>

  <!-- ===== ë‚´ ì±„íŒ…ë°© ===== -->
  <section id="page-my-chats" class="page" aria-labelledby="my-title">
    <button class="ghost" data-back>â† ë’¤ë¡œ</button>
    <h2 id="my-title">ë‚´ ì±„íŒ…ë°©</h2>
    <div id="my-chats" class="list"></div>
  </section>
</main>

<!-- ===== ì±„íŒ… ëª¨ë‹¬ ===== -->
<div id="chatModal" class="dialog">
  <div class="chatbox">
    <div class="row" style="justify-content:space-between;align-items:center;">
      <h3 id="chatTitle" style="margin:0;">ì±„íŒ…ë°©</h3>
      <button id="closeChat" class="ghost">ë‹«ê¸°</button>
    </div>
    <div id="chatlog" class="chatlog"></div>
    <div class="row"><input id="chat-input" style="flex:1;padding:10px;border-radius:10px;border:1px solid #e5e7eb;" placeholder="ë©”ì‹œì§€ ì…ë ¥(ê°œì¸ì •ë³´ ê¸ˆì§€)"/><button id="chat-send" class="primary">ë³´ë‚´ê¸°</button></div>
  </div>
</div>

<script type="module">
import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm';

/* ===== Supabase í´ë¼ì´ì–¸íŠ¸ ===== */
const sb = createClient(
  'https://upmghgogtalctkydifeh.supabase.co',
  'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InVwbWdoZ29ndGFsY3RreWRpZmVoIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjE1NTkzNDIsImV4cCI6MjA3NzEzNTM0Mn0.BaV43taAaKBMOKfILmo9s4phjHRkhfOHsW5w7BqZErg'
);

/* ===== ìœ í‹¸ / í”„ë¡œí•„ ===== */
const $=s=>document.querySelector(s), $$=s=>Array.from(document.querySelectorAll(s));
function showPage(id){$$('.page').forEach(p=>p.classList.remove('active'));$('#'+id).classList.add('active');window.scrollTo({top:0,behavior:'smooth'});}
$$('#home .section-block').forEach(b=>b.addEventListener('click',()=>showPage(b.dataset.go)));
$$('[data-back]').forEach(b=>b.addEventListener('click',()=>showPage('home')));

function randId(){const a=['ìƒˆ','ê³ ì–‘ì´','ê°•ì•„ì§€','ì‚¬ìŠ´','ë‹¬','ë³„','í•˜ëŠ˜'];const c=['í‘¸ë¥¸','ì€ë¹›','ë”°ëœ»í•œ','ì”ì”í•œ'];return c[Math.floor(Math.random()*c.length)]+a[Math.floor(Math.random()*a.length)]+Math.floor(100+Math.random()*900);}
function getProfile(){try{return JSON.parse(localStorage.getItem('nb_profile')||'null');}catch{return null;}}
function setProfile(p){localStorage.setItem('nb_profile',JSON.stringify(p));}
async function ensureProfile(){let p=getProfile();if(p&&p.id&&p.nickname)return p;const nickname=prompt('ë‹‰ë„¤ì„ì„ ì…ë ¥í•˜ì„¸ìš”(ì‹¤ëª… ê¸ˆì§€):')||'ìµëª…';p={id:randId(),nickname};setProfile(p);return p;}
$('#edit-profile').addEventListener('click',()=>{const n=prompt('ìƒˆ ë‹‰ë„¤ì„:');if(!n) return; const p=getProfile()||{id:randId()};p.nickname=n;setProfile(p);alert('ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.');});
let PROFILE=await ensureProfile();

// âœ… UTC ëŒ€ì‹  ë¡œì»¬ ê¸°ì¤€ ë‚ ì§œ ë¬¸ìì—´ ë°˜í™˜
function isoLocal(d) {
  const y = d.getFullYear();
  const m = String(d.getMonth() + 1).padStart(2, '0');
  const day = String(d.getDate()).padStart(2, '0');
  return `${y}-${m}-${day}`;
}

// âœ… ì´ˆê¸°ê°’ë„ ë¡œì»¬ ê¸°ì¤€ìœ¼ë¡œ
const DATE = { meal: isoLocal(new Date()), act: isoLocal(new Date()) };

// âœ… ê° ë²„íŠ¼ í´ë¦­ ì‹œ ë¡œì»¬ ê¸°ì¤€ìœ¼ë¡œ ë‚ ì§œ ê°±ì‹ 
function bindDateGroup(group) {
  const btns = document.querySelectorAll(`.date-btn[data-group="${group}"]`);
  btns.forEach(btn => {
    btn.addEventListener('click', () => {
      btns.forEach(b => b.setAttribute('aria-pressed', 'false'));
      btn.setAttribute('aria-pressed', 'true');
      const offset = parseInt(btn.dataset.date || '0', 10);
      const d = new Date();
      d.setDate(d.getDate() + offset);  // ë¡œì»¬ ê¸°ì¤€ ì´ë™
      DATE[group] = isoLocal(d);        // âœ… isoLocal ì‚¬ìš©
      console.log(`[${group}] ì„ íƒëœ ë‚ ì§œ:`, DATE[group]); // ë””ë²„ê·¸ í™•ì¸ìš©
    });
  });
}

bindDateGroup('meal');
bindDateGroup('act');

/* ===== ì‹ì‚¬ ëª¨ì„: ë°©ì¥ ìë™ì°¸ì—¬ + ì±„íŒ…ë°© ìë™ìƒì„± ===== */
$('#meal-save').addEventListener('click', async ()=>{
    PROFILE = await ensureProfile();

    // ì…ë ¥ê°’
    const date = DATE.meal;                           // âœ… ë¡œì»¬ ê¸°ì¤€ ë‚ ì§œ
    const slot = $('#meal-slot').value;
    const place = $('#meal-place').value;
    const capacity = Math.max(2, Math.min(10, parseInt($('#meal-cap').value||'2',10)));

    // 1) ëª¨ì„ ìƒì„±
    const { data: meetup, error: meetErr } = await sb
        .from('meal_meetups')
        .insert([{ date, slot, place, capacity, created_by: PROFILE.id, nickname: PROFILE.nickname }])
        .select()
        .single();

    if (meetErr) return alert('ë“±ë¡ ì‹¤íŒ¨: ' + meetErr.message);

    // 2) ë°©ì¥ ìë™ ì°¸ì—¬(ë‚¨ì€ìë¦¬ ê°ì†Œ/ë²„íŠ¼ ìƒíƒœ ìœ„í•´ ë°˜ë“œì‹œ í•„ìš”)
    const { error: memErr } = await sb
        .from('meal_members')
        .insert([{ meetup_id: meetup.id, user_id: PROFILE.id, nickname: PROFILE.nickname }]);
    if (memErr && memErr.code !== '23505') {
        console.warn('ë°©ì¥ ìë™ì°¸ì—¬ ì‹¤íŒ¨:', memErr.message);
        // ê³„ì† ì§„í–‰ì€ í•¨ (ì•„ë˜ ë°© ìƒì„±)
    }

    // 3) ì±„íŒ…ë°© ìƒì„± + ë°©ì¥ ì°¸ê°€ì ë“±ë¡
    const { data: room, error: roomErr } = await sb
        .from('rooms')
        .insert([{ meetup_id: meetup.id, created_by: PROFILE.id, created_by_nick: PROFILE.nickname }])
        .select()
        .single();

    if (roomErr) {
        console.error('ì±„íŒ…ë°© ìƒì„± ì‹¤íŒ¨:', roomErr.message);
        alert('ëª¨ì„ì€ ìƒì„±ë˜ì—ˆì§€ë§Œ ì±„íŒ…ë°© ìƒì„±ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
        await renderMeal();
        return;
    }

    // ë°©ì¥(ë³¸ì¸) ì±„íŒ…ë°© ì°¸ê°€ìë¡œ ë³´ì¥
    const { error: partErr } = await sb
        .from('room_participants')
        .upsert([{ room_id: room.id, user_id: PROFILE.id, nickname: PROFILE.nickname }]);
    if (partErr) console.warn('room_participants ë“±ë¡ ì‹¤íŒ¨:', partErr.message);

    // 4) UI ê°±ì‹ : ë‚¨ì€ìë¦¬ ê°ì†Œ + ë²„íŠ¼ â€œì°¸ì—¬ì¤‘/ì±„íŒ…â€ìœ¼ë¡œ ë°˜ì˜
    await renderMeal();

    // ì„ íƒ: ë°”ë¡œ ì±„íŒ… ì—´ê³  ì‹¶ìœ¼ë©´ ì£¼ì„ í•´ì œ
    // openChatModal(room.id, `${slot} Â· ${place} (${date})`);
    alert('ì‹ì‚¬ ëª¨ì„/ì±„íŒ…ë°©ì´ ìƒì„±ë˜ê³ , ë°©ì¥ìœ¼ë¡œ ìë™ ì°¸ì—¬ ì²˜ë¦¬ë˜ì—ˆìŠµë‹ˆë‹¤.');
});

async function joinMeal(id){ PROFILE=await ensureProfile(); const { error }=await sb.from('meal_members').insert([{ meetup_id:id, user_id:PROFILE.id, nickname:PROFILE.nickname }]); if(error&&error.code!=='23505') return alert('ì°¸ì—¬ ì‹¤íŒ¨: '+error.message); await openOrCreateRoom(id,'meal'); renderMeal(); }
async function leaveMeal(id){ PROFILE=await ensureProfile(); await sb.from('meal_members').delete().match({ meetup_id:id, user_id:PROFILE.id }); renderMeal(); }
async function delMeal(id){ PROFILE=await ensureProfile(); await sb.from('meal_meetups').delete().match({ id, created_by:PROFILE.id }); renderMeal(); }
async function fetchMealView(){ const { data: meets }=await sb.from('meal_meetups').select('*').order('date'); const { data: members }=await sb.from('meal_members').select('*'); return { meets:meets||[], members:members||[] }; }
async function renderMeal(){
  const wrap=$('#meal-list'); wrap.innerHTML='<p class="item">ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘â€¦</p>';
  const { meets, members } = await fetchMealView();
  $('#meal-count').textContent=`${meets.length}ê±´`;
  if(meets.length===0){ wrap.innerHTML='<p class="item">ëª¨ì„ì´ ì—†ìŠµë‹ˆë‹¤.</p>'; return; }
  wrap.innerHTML = meets.map(m=>{
    const joined = members.some(x=>x.meetup_id===m.id && x.user_id===PROFILE.id);
    const cnt = members.filter(x=>x.meetup_id===m.id).length;
    const left = Math.max(0,(m.capacity||0)-cnt);
    const isOwner = m.created_by===PROFILE.id;
    return `
    <div class="item">
      <div><b>${m.slot}</b> Â· ${m.place} <span class="badge">${m.date}</span></div>
      <div class="meta">ì •ì› ${m.capacity} Â· ë‚¨ì€ìë¦¬ ${left}/${m.capacity} Â· ë§Œë“ ì´ ${m.nickname||'ìµëª…'}</div>
      <div class="row" style="justify-content:flex-end;">
        ${isOwner? `<button class="ghost" data-mdel="${m.id}">ì‚­ì œ</button>`:''}
        ${joined? `<button class="ghost" data-mleave="${m.id}">ì·¨ì†Œí•˜ê¸°</button><button class="primary" data-mchat="${m.id}" data-type="meal">ì±„íŒ…</button>`
                 : `<button class="primary" data-mjoin="${m.id}" ${left===0?'disabled':''}>ì°¸ì—¬í•˜ê¸°</button>`}
      </div>
    </div>`;
  }).join('');
  $$('#meal-list [data-mjoin]').forEach(b=> b.addEventListener('click', ()=> joinMeal(b.dataset.mjoin)));
  $$('#meal-list [data-mleave]').forEach(b=> b.addEventListener('click', ()=> leaveMeal(b.dataset.mleave)));
  $$('#meal-list [data-mdel]').forEach(b=> b.addEventListener('click', ()=> delMeal(b.dataset.mdel)));
  $$('#meal-list [data-mchat]').forEach(b=> b.addEventListener('click', async ()=>{ await openOrCreateRoom(b.dataset.mchat,'meal'); }));
}
$('#meal-refresh').addEventListener('click', renderMeal);

/* ===== ê´€ì‹¬ì‚¬ ëª¨ì„: ë°©ì¥ ìë™ì°¸ì—¬ + ì±„íŒ…ë°© ìë™ìƒì„± ===== */
function pickTags(containerSel){ 
  const chosen=[]; 
  $$(containerSel+' .tag[aria-pressed="true"]').forEach(t=>chosen.push(t.textContent.trim())); 
  return chosen; 
}

$('#act-tags').addEventListener('click', (e)=>{
  const b=e.target.closest('.tag');
  if(!b) return;
  b.setAttribute('aria-pressed', String(b.getAttribute('aria-pressed')!=='true'));
});

$('#act-save').addEventListener('click', async ()=>{
  PROFILE = await ensureProfile();

  const date = DATE.act;
  const slot = $('#act-slot').value;
  const place = $('#act-place').value;
  const note = $('#act-note').value.trim();
  const capacity = Math.max(2, Math.min(10, parseInt($('#act-cap').value||'2',10)));
  const tags = pickTags('#act-tags');

  try {
    // 1ï¸âƒ£ ëª¨ì„ ìƒì„±
    const { data: meetup, error: actErr } = await sb
      .from('activity_meetups')
      .insert([{ date, slot, place, capacity, tags, note, created_by: PROFILE.id, nickname: PROFILE.nickname }])
      .select()
      .single();
    if (actErr) throw actErr;

    // 2ï¸âƒ£ ë°©ì¥ ìë™ì°¸ì—¬(activity_members)
    const { error: memErr } = await sb
      .from('activity_members')
      .insert([{ meetup_id: meetup.id, user_id: PROFILE.id, nickname: PROFILE.nickname }]);
    if (memErr && memErr.code !== '23505') console.warn('ë°©ì¥ ìë™ì°¸ì—¬ ì‹¤íŒ¨:', memErr.message);

    // 3ï¸âƒ£ ì±„íŒ…ë°© ìƒì„± (rooms)
    const { data: room, error: roomErr } = await sb
      .from('rooms')
      .insert([{ meetup_id: meetup.id, created_by: PROFILE.id, created_by_nick: PROFILE.nickname }])
      .select()
      .single();
    if (roomErr) throw roomErr;

    // 4ï¸âƒ£ ë°©ì¥ room_participants ë“±ë¡
    const { error: partErr } = await sb
      .from('room_participants')
      .upsert([{ room_id: room.id, user_id: PROFILE.id, nickname: PROFILE.nickname }]);
    if (partErr) console.warn('room_participants ë“±ë¡ ì‹¤íŒ¨:', partErr.message);

    // 5ï¸âƒ£ UI ê°±ì‹ 
    await renderActivity();

    alert('ğŸ¯ ê´€ì‹¬ì‚¬ ëª¨ì„/ì±„íŒ…ë°©ì´ ìƒì„±ë˜ê³ , ë°©ì¥ì´ ìë™ ì°¸ì—¬ë˜ì—ˆìŠµë‹ˆë‹¤.');
  } catch (e) {
    console.error('ê´€ì‹¬ì‚¬ ëª¨ì„ ìƒì„± ì‹¤íŒ¨:', e.message);
    alert('âŒ ê´€ì‹¬ì‚¬ ëª¨ì„ ìƒì„± ì¤‘ ì˜¤ë¥˜: ' + e.message);
  }
});

async function joinActivity(id){
  PROFILE = await ensureProfile();
  const { error } = await sb.from('activity_members')
    .insert([{ meetup_id:id, user_id:PROFILE.id, nickname:PROFILE.nickname }]);
  if (error && error.code !== '23505') return alert('ì°¸ì—¬ ì‹¤íŒ¨: ' + error.message);
  await openOrCreateRoom(id,'act');
  renderActivity();
}

async function leaveActivity(id){
  PROFILE = await ensureProfile();
  await sb.from('activity_members').delete().match({ meetup_id:id, user_id:PROFILE.id });
  renderActivity();
}

async function delActivity(id){
  PROFILE = await ensureProfile();
  await sb.from('activity_meetups').delete().match({ id, created_by:PROFILE.id });
  renderActivity();
}

let ACT_FILTER_MY = false;
$('#act-filter-my').addEventListener('click',()=>{
  ACT_FILTER_MY = !ACT_FILTER_MY;
  $('#act-filter-my').classList.toggle('primary',ACT_FILTER_MY);
  renderActivity();
});

async function fetchActivityView(){
  const { data: meets } = await sb.from('activity_meetups').select('*').order('date');
  const { data: members } = await sb.from('activity_members').select('*');
  return { meets: meets||[], members: members||[] };
}

async function renderActivity(){
  const wrap = $('#act-list');
  wrap.innerHTML = '<p class="item">ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘â€¦</p>';
  const { meets, members } = await fetchActivityView();
  $('#act-count').textContent = `${meets.length}ê±´`;

  const myTags = new Set(pickTags('#act-tags'));
  const filtered = ACT_FILTER_MY && myTags.size>0 
    ? meets.filter(m => (m.tags||[]).some(t => myTags.has(t)))
    : meets;

  if (filtered.length === 0) {
    wrap.innerHTML = '<p class="item">ëª¨ì„ì´ ì—†ìŠµë‹ˆë‹¤.</p>';
    return;
  }

  wrap.innerHTML = filtered.map(m=>{
    const joined = members.some(x=>x.meetup_id===m.id && x.user_id===PROFILE.id);
    const cnt = members.filter(x=>x.meetup_id===m.id).length;
    const left = Math.max(0,(m.capacity||0)-cnt);
    const isOwner = m.created_by === PROFILE.id;
    const tagStr = (m.tags||[]).join(', ');
    return `
    <div class="item">
      <div><b>${m.slot}</b> Â· ${m.place} <span class="badge">${m.date}</span></div>
      <div class="meta">
        ê´€ì‹¬ì‚¬: ${tagStr||'ì—†ìŒ'} Â· ì •ì› ${m.capacity} Â· ë‚¨ì€ìë¦¬ ${left}/${m.capacity} Â· ë§Œë“ ì´ ${m.nickname||'ìµëª…'}
      </div>
      <div class="row" style="justify-content:flex-end;">
        ${isOwner
          ? `<button class="ghost" data-ad="${m.id}">ì‚­ì œ</button>`
          : ''}
        ${joined
          ? `<button class="ghost" data-al="${m.id}">ì·¨ì†Œí•˜ê¸°</button>
             <button class="primary" data-ach="${m.id}" data-type="act">ì±„íŒ…</button>`
          : `<button class="primary" data-aj="${m.id}" ${left===0?'disabled':''}>ì°¸ì—¬í•˜ê¸°</button>`}
      </div>
    </div>`;
  }).join('');

  $$('#act-list [data-aj]').forEach(b=> b.addEventListener('click', ()=> joinActivity(b.dataset.aj)));
  $$('#act-list [data-al]').forEach(b=> b.addEventListener('click', ()=> leaveActivity(b.dataset.al)));
  $$('#act-list [data-ad]').forEach(b=> b.addEventListener('click', ()=> delActivity(b.dataset.ad)));
  $$('#act-list [data-ach]').forEach(b=> b.addEventListener('click', async ()=>{
    await openOrCreateRoom(b.dataset.ach,'act');
  }));
}

$('#act-refresh').addEventListener('click', renderActivity);


/* ===== 1:1 ë§¤ì¹­ (Supabase ê¸°ë°˜ ì‹¤ì‹œê°„ ë²„ì „) ===== */
let matchInterval = null;
let isMatching = false;

function updateMatchState(text) {
  $('#match-state').textContent = text;
  addDemoMsg(text);
}

async function startMatching() {
  PROFILE = await ensureProfile();
  if (isMatching) return;

  isMatching = true;
  updateMatchState('ë§¤ì¹­ ëŒ€ê¸°ì—´ ë“±ë¡ ì¤‘...');

  // 1ï¸âƒ£ ë³¸ì¸ì„ ëŒ€ê¸°ì—´ì— ë“±ë¡ (ì¤‘ë³µ ì‹œ upsert)
  const { error: insertErr } = await sb
    .from('match_queue')
    .upsert([{ user_id: PROFILE.id, nickname: PROFILE.nickname }]);
  if (insertErr) {
    isMatching = false;
    return alert('ë§¤ì¹­ ëŒ€ê¸° ë“±ë¡ ì‹¤íŒ¨: ' + insertErr.message);
  }

  updateMatchState('ë§¤ì¹­ ëŒ€ê¸° ì¤‘... (3ì´ˆë§ˆë‹¤ ìƒëŒ€ íƒìƒ‰)');

  // 2ï¸âƒ£ 3ì´ˆë§ˆë‹¤ ë‹¤ë¥¸ ëŒ€ê¸°ì íƒìƒ‰
  matchInterval = setInterval(async () => {
    const { data: queue } = await sb
      .from('match_queue')
      .select('*')
      .order('created_at');

    const others = (queue || []).filter(q => q.user_id !== PROFILE.id);
    if (others.length > 0) {
      const partner = others[0];
      updateMatchState(`ë§¤ì¹­ ì„±ê³µ! ìƒëŒ€: ${partner.nickname}`);

      clearInterval(matchInterval);
      isMatching = false;

      // 3ï¸âƒ£ ì±„íŒ…ë°© ìƒì„±
      const { data: room, error: roomErr } = await sb
        .from('rooms')
        .insert([{ created_by: PROFILE.id, created_by_nick: PROFILE.nickname, type: 'direct' }])
        .select()
        .single();

      if (roomErr) return alert('ì±„íŒ…ë°© ìƒì„± ì‹¤íŒ¨: ' + roomErr.message);

      // 4ï¸âƒ£ ë‘ ì°¸ê°€ì ë“±ë¡
      await sb.from('room_participants').insert([
        { room_id: room.id, user_id: PROFILE.id, nickname: PROFILE.nickname },
        { room_id: room.id, user_id: partner.user_id, nickname: partner.nickname },
      ]);

      // 5ï¸âƒ£ ëŒ€ê¸°ì—´ì—ì„œ ì œê±°
      await sb.from('match_queue').delete().in('user_id', [PROFILE.id, partner.user_id]);

      // 6ï¸âƒ£ ì±„íŒ…ë°© ì—´ê¸°
      openChatModal(room.id, `1:1 ëŒ€í™” (${partner.nickname})`);
    }
  }, 3000);
}

async function cancelMatching() {
  PROFILE = await ensureProfile();
  await sb.from('match_queue').delete().eq('user_id', PROFILE.id);
  clearInterval(matchInterval);
  isMatching = false;
  updateMatchState('ë§¤ì¹­ì´ ì·¨ì†Œë˜ì—ˆìŠµë‹ˆë‹¤.');
}

// UI ì´ë²¤íŠ¸
$('#match-start').addEventListener('click', () => {
  if (isMatching) {
    cancelMatching();
    $('#match-start').textContent = 'ë§¤ì¹­ ìš”ì²­';
    $('#match-start').classList.remove('ghost');
    $('#match-start').classList.add('primary');
  } else {
    startMatching();
    $('#match-start').textContent = 'ë§¤ì¹­ ì·¨ì†Œ';
    $('#match-start').classList.remove('primary');
    $('#match-start').classList.add('ghost');
  }
});


/* ===== ì±„íŒ…ë°©/ë©”ì‹œì§€ ===== */
let ACTIVE_ROOM=null, msgSub=null;
function setChatTitle(roomId, title){ $('#chatTitle').textContent = title? `ì±„íŒ…ë°© Â· ${title}` : `ì±„íŒ…ë°© (${roomId.slice(0,6)})`; }
function appendMsg(m){ const box=$('#chatlog'); const el=document.createElement('div'); el.className='bubble '+(m.user_id===PROFILE.id?'me':'other'); el.textContent=`${m.nickname}: ${m.text}`; box.appendChild(el); box.scrollTop=box.scrollHeight; }
async function renderChat(roomId){ const box=$('#chatlog'); box.innerHTML='ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘â€¦'; const { data: msgs }=await sb.from('messages').select('*').eq('room_id',roomId).order('created_at',{ascending:true}); box.innerHTML=''; (msgs||[]).forEach(appendMsg); }

async function openOrCreateRoom(meetup_id, type){
  PROFILE=await ensureProfile();
  // ì°¸ê°€ì ëª©ë¡
  let mems=[];
  if(type==='meal'){ const { data }=await sb.from('meal_members').select('user_id,nickname').eq('meetup_id',meetup_id); mems=data||[]; }
  else{ const { data }=await sb.from('activity_members').select('user_id,nickname').eq('meetup_id',meetup_id); mems=data||[]; }
  // ë°© ì¡°íšŒ/ìƒì„±
  let { data: room }=await sb.from('rooms').select('*').eq('meetup_id',meetup_id).maybeSingle();
  if(!room){
    const { data: created, error }=await sb.from('rooms').insert([{ meetup_id, created_by:PROFILE.id, created_by_nick:PROFILE.nickname }]).select().single();
    if(error) return alert('ì±„íŒ…ë°© ìƒì„± ì‹¤íŒ¨: '+error.message);
    room=created;
    const parts = mems.map(m=>({ room_id:room.id, user_id:m.user_id, nickname:m.nickname }));
    if(parts.length) await sb.from('room_participants').insert(parts);
  }else{
    await sb.from('room_participants').upsert([{ room_id:room.id, user_id:PROFILE.id, nickname:PROFILE.nickname }]);
  }
  // íƒ€ì´í‹€
  let title='';
  if(type==='meal'){ const { data: meet }=await sb.from('meal_meetups').select('slot,place,date').eq('id',meetup_id).maybeSingle(); if(meet) title=`${meet.slot} Â· ${meet.place} (${meet.date})`; }
  else{ const { data: meet }=await sb.from('activity_meetups').select('slot,place,date').eq('id',meetup_id).maybeSingle(); if(meet) title=`${meet.slot} Â· ${meet.place} (${meet.date})`; }
  openChatModal(room.id, title);
}

function openChatModal(roomId, title){
  ACTIVE_ROOM=roomId;
  setChatTitle(roomId, title);
  $('#chatModal').classList.add('active');

  // ì¤‘ë³µ êµ¬ë… ì œê±° + ì´ˆê¸° ë¡œë“œ
  sb.removeAllChannels();
  renderChat(roomId);

  // ì‹¤ì‹œê°„ êµ¬ë…
  msgSub = sb.channel('msg_'+roomId)
    .on('postgres_changes', { event:'INSERT', schema:'public', table:'messages', filter:`room_id=eq.${roomId}` },
      payload=>appendMsg(payload.new))
    .subscribe();
}
function closeChatModal(){ $('#chatModal').classList.remove('active'); sb.removeAllChannels(); ACTIVE_ROOM=null; }
$('#closeChat').addEventListener('click', closeChatModal);

$('#chat-send').addEventListener('click', async ()=>{
  if(!ACTIVE_ROOM) return;
  const input=$('#chat-input'); const text=input.value.trim();
  if(!text) return; input.value='';
  const { error } = await sb.from('messages').insert([{ room_id:ACTIVE_ROOM, user_id:PROFILE.id, nickname:PROFILE.nickname, text }]);
  if(error) return alert('ì „ì†¡ ì‹¤íŒ¨: '+error.message);
  appendMsg({ user_id:PROFILE.id, nickname:PROFILE.nickname, text }); // ì¦‰ì‹œ ë°˜ì˜
  // í•„ìš”ì‹œ ì¬ë¡œë”©: await renderChat(ACTIVE_ROOM);
});

/* ===== ë‚´ ì±„íŒ…ë°© ===== */
async function renderMyChats() {
  PROFILE = await ensureProfile();
  const { data: parts } = await sb
    .from('room_participants')
    .select('room_id')
    .eq('user_id', PROFILE.id);

  const ids = (parts || []).map(p => p.room_id);
  const wrap = $('#my-chats');

  if (!ids.length) {
    wrap.innerHTML = '<p class="item">ì°¸ì—¬ ì¤‘ì¸ ì±„íŒ…ë°©ì´ ì—†ìŠµë‹ˆë‹¤.</p>';
    return;
  }

  // âœ… rooms, meals, acts ëª¨ë‘ ë¶ˆëŸ¬ì˜¤ê¸°
  const { data: rooms } = await sb
    .from('rooms')
    .select('id, meetup_id, created_by_nick, created_at')
    .in('id', ids);

  const { data: meals } = await sb
    .from('meal_meetups')
    .select('id, slot, place, date');

  const { data: acts } = await sb
    .from('activity_meetups')
    .select('id, slot, place, date, tags');

  // âœ… ë Œë”ë§
  wrap.innerHTML = (rooms || [])
    .map(r => {
      // ëª¨ì„ ì •ë³´ ì°¾ê¸°
      const meal = (meals || []).find(x => x.id === r.meetup_id);
      const act = (acts || []).find(x => x.id === r.meetup_id);

      let title = '';
      let typeLabel = '';
      let tagLabel = '';

      if (meal) {
        typeLabel = 'ğŸš ì‹ì‚¬ ëª¨ì„';
        title = `${meal.slot} Â· ${meal.place} (${meal.date})`;
      } else if (act) {
        typeLabel = 'ğŸ¯ ê´€ì‹¬ì‚¬ ëª¨ì„';
        const tags = act.tags && act.tags.length
          ? act.tags.join(', ')
          : 'ê´€ì‹¬ì‚¬ ì—†ìŒ';
        tagLabel = `<div class="meta">ê´€ì‹¬ì‚¬: ${tags}</div>`;
        title = `${act.slot} Â· ${act.place} (${act.date})`;
      } else {
        typeLabel = 'ğŸ’¬ ê¸°íƒ€ ë°©';
        title = `ë°© ${r.id.slice(0, 6)}`;
      }

      return `
      <div class="item">
        <div><b>${typeLabel}</b> Â· ${title}</div>
        ${tagLabel}
        <div class="meta">ë°©ì¥: ${r.created_by_nick || 'ìµëª…'} Â· ìƒì„±ì¼: ${String(r.created_at).slice(0, 10)}</div>
        <div class="row" style="justify-content:flex-end;">
          <button class="primary" data-open="${r.id}">ì…ì¥í•˜ê¸°</button>
        </div>
      </div>`;
    })
    .join('');

  // í´ë¦­ ì´ë²¤íŠ¸
  $$('#my-chats [data-open]').forEach(b =>
    b.addEventListener('click', async () => {
      const roomId = b.dataset.open;
      const { data: room } = await sb
        .from('rooms')
        .select('meetup_id')
        .eq('id', roomId)
        .maybeSingle();

      let title = '';
      if (room && room.meetup_id) {
        const { data: mm } = await sb
          .from('meal_meetups')
          .select('slot, place, date')
          .eq('id', room.meetup_id)
          .maybeSingle();

        const { data: aa } = await sb
          .from('activity_meetups')
          .select('slot, place, date, tags')
          .eq('id', room.meetup_id)
          .maybeSingle();

        if (mm) title = `ğŸš ì‹ì‚¬ ëª¨ì„ Â· ${mm.slot} Â· ${mm.place} (${mm.date})`;
        else if (aa) {
          const tags = aa.tags && aa.tags.length
            ? aa.tags.join(', ')
            : 'ê´€ì‹¬ì‚¬ ì—†ìŒ';
          title = `ğŸ¯ ê´€ì‹¬ì‚¬ ëª¨ì„ Â· ${tags} Â· ${aa.slot} Â· ${aa.place} (${aa.date})`;
        }
      }
      openChatModal(roomId, title);
    })
  );
}

$$('[data-go="page-my-chats"]').forEach(btn=>btn.addEventListener('click',()=>{ showPage('page-my-chats'); renderMyChats(); }));

/* ===== ì´ˆê¸° ë Œë” ===== */
showPage('home');
renderMeal();
renderActivity();
</script>
</body>
</html>


